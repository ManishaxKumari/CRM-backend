{% extends 'execution_plans/base.html' %}

{% block title %}Design Execution Plan{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'create_plan' %}">Create Plan</a></li>
        <li class="breadcrumb-item active">Design Plan</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">
        <i class="fas fa-drafting-compass text-primary me-2"></i>
        Design Execution Plan for {{ client.name }}
    </h1>
</div>

<form id="executionPlanForm">
    {% csrf_token %}
    <div class="row">
        <!-- Plan Details -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>Plan Details
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="planName" class="form-label">Plan Name *</label>
                        <input type="text" class="form-control" id="planName" name="plan_name" required 
                               placeholder="Enter plan name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="planDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="planDescription" name="description" rows="3" 
                                  placeholder="Enter plan description (optional)"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Client Information</label>
                        <div class="bg-light p-3 rounded">
                            <div><strong>Name:</strong> {{ client.name }}</div>
                            {% if client.pan %}
                                <div><strong>PAN:</strong> {{ client.pan }}</div>
                            {% endif %}
                            {% if total_portfolio_value %}
                                <div><strong>Total AUM:</strong> ₹{{ total_portfolio_value|floatformat:2 }}</div>
                            {% endif %}
                            {% if asset_allocation %}
                                <div class="mt-2">
                                    <small><strong>Asset Allocation:</strong></small>
                                    <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% if asset_allocation.total_equity %}
                                            <span class="badge bg-success">Equity: ₹{{ asset_allocation.total_equity|floatformat:0 }}</span>
                                        {% endif %}
                                        {% if asset_allocation.total_debt %}
                                            <span class="badge bg-info">Debt: ₹{{ asset_allocation.total_debt|floatformat:0 }}</span>
                                        {% endif %}
                                        {% if asset_allocation.total_hybrid %}
                                            <span class="badge bg-warning">Hybrid: ₹{{ asset_allocation.total_hybrid|floatformat:0 }}</span>
                                        {% endif %}
                                        {% if asset_allocation.total_liquid %}
                                            <span class="badge bg-secondary">Liquid: ₹{{ asset_allocation.total_liquid|floatformat:0 }}</span>
                                        {% endif %}
                                        {% if asset_allocation.total_other %}
                                            <span class="badge bg-dark">Other: ₹{{ asset_allocation.total_other|floatformat:0 }}</span>
                                        {% endif %}
                                        {% if asset_allocation.total_arbitrage %}
                                            <span class="badge bg-light text-dark">Arbitrage: ₹{{ asset_allocation.total_arbitrage|floatformat:0 }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Templates -->
            {% if templates %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-template me-2"></i>Templates
                    </h6>
                </div>
                <div class="card-body">
                    <select class="form-control" id="templateSelect">
                        <option value="">Select a template...</option>
                        {% for template in templates %}
                            <option value="{{ template.id }}">{{ template.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Load actions from a saved template</div>
                </div>
            </div>
            {% endif %}
            
            <!-- Portfolio Summary -->
            {% if portfolio_summary %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Portfolio Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h6 class="mb-1 text-primary">Total Schemes</h6>
                                <strong>{{ portfolio_summary.total_schemes }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <h6 class="mb-1 text-success">Avg Value</h6>
                            <strong>₹{{ portfolio_summary.average_scheme_value|floatformat:0 }}</strong>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row text-center small">
                        <div class="col-6">
                            <div><strong class="text-success">{{ portfolio_summary.redeemable_schemes }}</strong> Redeemable</div>
                        </div>
                        <div class="col-6">
                            <div><strong class="text-primary">{{ portfolio_summary.switchable_schemes }}</strong> Switchable</div>
                        </div>
                    </div>
                    <div class="row text-center small mt-1">
                        <div class="col-6">
                            <div><strong class="text-info">{{ portfolio_summary.stp_eligible_schemes }}</strong> STP Eligible</div>
                        </div>
                        <div class="col-6">
                            <div><strong class="text-warning">{{ portfolio_summary.swp_eligible_schemes }}</strong> SWP Eligible</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Current Portfolio - Enhanced -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-wallet me-2"></i>Current Portfolio
                        {% if portfolio_data %}
                            <span class="badge bg-light text-dark ms-2">{{ portfolio_data|length }} Holdings</span>
                        {% endif %}
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-light btn-sm" id="portfolioViewToggle" data-view="summary">
                            <i class="fas fa-table me-1"></i>Detailed View
                        </button>
                        <button type="button" class="btn btn-light btn-sm" onclick="exportPortfolio()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if portfolio_data %}
                        <!-- Portfolio Summary -->
                        <div id="portfolioSummary" class="p-3 bg-light border-bottom">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border-end">
                                        <h6 class="mb-1 text-success">Total Value</h6>
                                        <strong>₹{{ total_portfolio_value|default:0|floatformat:0 }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border-end">
                                        <h6 class="mb-1 text-primary">Holdings</h6>
                                        <strong>{{ portfolio_data|length }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border-end">
                                        <h6 class="mb-1 text-info">Equity Exposure</h6>
                                        <strong id="equity-percentage">-</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div>
                                        <h6 class="mb-1 text-warning">Debt Exposure</h6>
                                        <strong id="debt-percentage">-</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Portfolio Table -->
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-hover table-sm mb-0" id="portfolioTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="min-width: 250px;">Scheme Details</th>
                                        <th class="text-end">Current Value</th>
                                        <th class="text-end">Units</th>
                                        <th class="text-center">Asset Class</th>
                                        <th class="text-end">Allocation %</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for holding in portfolio_data %}
                                    <tr data-portfolio-id="{{ holding.id }}" 
                                        data-scheme-name="{{ holding.scheme_name }}"
                                        data-current-value="{{ holding.current_value }}"
                                        data-equity-value="{{ holding.equity_value|default:0 }}"
                                        data-debt-value="{{ holding.debt_value|default:0 }}"
                                        data-hybrid-value="{{ holding.hybrid_value|default:0 }}"
                                        data-liquid-value="{{ holding.liquid_value|default:0 }}"
                                        data-other-value="{{ holding.other_value|default:0 }}"
                                        data-arbitrage-value="{{ holding.arbitrage_value|default:0 }}">
                                        <td>
                                            <div>
                                                <strong class="text-primary">
                                                    {{ holding.scheme_name|truncatechars:45 }}
                                                </strong>
                                                {% if holding.isin_number %}
                                                    <br><small class="text-muted">ISIN: {{ holding.isin_number }}</small>
                                                {% endif %}
                                                {% if holding.folio_number %}
                                                    <br><small class="badge bg-secondary">Folio: {{ holding.folio_number }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <strong class="text-success">
                                                ₹{{ holding.current_value|floatformat:0 }}
                                            </strong>
                                            {% if holding.cost_value and holding.cost_value > 0 %}
                                                <br><small class="text-muted">Cost: ₹{{ holding.cost_value|floatformat:0 }}</small>
                                                {% if holding.gain_loss %}
                                                    <br><small class="{% if holding.gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                        {% if holding.gain_loss >= 0 %}+{% endif %}{{ holding.gain_loss|floatformat:0 }} ({{ holding.gain_loss_percentage|floatformat:1 }}%)
                                                    </small>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <span class="text-dark">{{ holding.units|floatformat:4 }}</span>
                                        </td>
                                        <td class="text-center">
                                            {% if holding.primary_asset_class %}
                                                <span class="badge 
                                                    {% if holding.primary_asset_class == 'Equity' %}bg-success
                                                    {% elif holding.primary_asset_class == 'Debt' %}bg-info
                                                    {% elif holding.primary_asset_class == 'Hybrid' %}bg-warning
                                                    {% elif holding.primary_asset_class == 'Liquid' %}bg-secondary
                                                    {% else %}bg-light text-dark{% endif %}">
                                                    {{ holding.primary_asset_class }}
                                                </span>
                                            {% else %}
                                                <!-- Determine primary asset class from values -->
                                                {% if holding.equity_value > holding.debt_value and holding.equity_value > holding.hybrid_value %}
                                                    <span class="badge bg-success">Equity</span>
                                                {% elif holding.debt_value > holding.equity_value and holding.debt_value > holding.hybrid_value %}
                                                    <span class="badge bg-info">Debt</span>
                                                {% elif holding.hybrid_value > 0 %}
                                                    <span class="badge bg-warning">Hybrid</span>
                                                {% elif holding.liquid_value > 0 %}
                                                    <span class="badge bg-secondary">Liquid</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">Mixed</span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if holding.allocation_percentage %}
                                                {{ holding.allocation_percentage|floatformat:2 }}%
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-outline-danger btn-sm portfolio-action-btn" 
                                                        data-portfolio-id="{{ holding.id }}" 
                                                        data-scheme-name="{{ holding.scheme_name }}"
                                                        data-action="redeem"
                                                        title="Redeem"
                                                        {% if not holding.can_redeem %}disabled{% endif %}>
                                                    <i class="fas fa-minus-circle"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-primary btn-sm portfolio-action-btn" 
                                                        data-portfolio-id="{{ holding.id }}" 
                                                        data-scheme-name="{{ holding.scheme_name }}"
                                                        data-action="switch"
                                                        title="Switch"
                                                        {% if not holding.can_switch %}disabled{% endif %}>
                                                    <i class="fas fa-exchange-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm portfolio-action-btn" 
                                                        data-portfolio-id="{{ holding.id }}" 
                                                        data-scheme-name="{{ holding.scheme_name }}"
                                                        data-action="stp"
                                                        title="STP"
                                                        {% if not holding.can_stp %}disabled{% endif %}>
                                                    <i class="fas fa-arrow-right"></i>
                                                </button>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                                            data-bs-toggle="dropdown" title="More Actions">
                                                        <i class="fas fa-ellipsis-h"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item portfolio-action-btn" href="#" 
                                                               data-portfolio-id="{{ holding.id }}" 
                                                               data-scheme-name="{{ holding.scheme_name }}"
                                                               data-action="sip">
                                                            <i class="fas fa-plus-circle me-2"></i>Start SIP
                                                        </a></li>
                                                        <li><a class="dropdown-item portfolio-action-btn" href="#" 
                                                               data-portfolio-id="{{ holding.id }}" 
                                                               data-scheme-name="{{ holding.scheme_name }}"
                                                               data-action="swp"
                                                               {% if not holding.can_swp %}style="color: #ccc; pointer-events: none;"{% endif %}>
                                                            <i class="fas fa-arrow-down me-2"></i>Start SWP
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Portfolio Asset Allocation -->
                        {% if asset_allocation %}
                        <div class="p-3 border-top bg-light">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-2">Asset Allocation Breakdown</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% if asset_allocation.total_equity %}
                                            <span class="badge bg-success">
                                                Equity: ₹{{ asset_allocation.total_equity|floatformat:0 }} 
                                                (<span class="equity-pct">-</span>%)
                                            </span>
                                        {% endif %}
                                        {% if asset_allocation.total_debt %}
                                            <span class="badge bg-info">
                                                Debt: ₹{{ asset_allocation.total_debt|floatformat:0 }} 
                                                (<span class="debt-pct">-</span>%)
                                            </span>
                                        {% endif %}
                                        {% if asset_allocation.total_hybrid %}
                                            <span class="badge bg-warning">
                                                Hybrid: ₹{{ asset_allocation.total_hybrid|floatformat:0 }} 
                                                (<span class="hybrid-pct">-</span>%)
                                            </span>
                                        {% endif %}
                                        {% if asset_allocation.total_liquid %}
                                            <span class="badge bg-secondary">
                                                Liquid: ₹{{ asset_allocation.total_liquid|floatformat:0 }} 
                                                (<span class="liquid-pct">-</span>%)
                                            </span>
                                        {% endif %}
                                        {% if asset_allocation.total_other %}
                                            <span class="badge bg-dark">
                                                Other: ₹{{ asset_allocation.total_other|floatformat:0 }} 
                                                (<span class="other-pct">-</span>%)
                                            </span>
                                        {% endif %}
                                        {% if asset_allocation.total_arbitrage %}
                                            <span class="badge bg-light text-dark">
                                                Arbitrage: ₹{{ asset_allocation.total_arbitrage|floatformat:0 }} 
                                                (<span class="arbitrage-pct">-</span>%)
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addBulkActions()">
                                        <i class="fas fa-layer-group me-1"></i>Bulk Actions
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted p-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <h5>No Portfolio Data Found</h5>
                            <p>No current portfolio found for this client. You can still create an execution plan by adding new investments.</p>
                            <button type="button" class="btn btn-outline-primary" onclick="$('#schemeSearch').focus()">
                                <i class="fas fa-plus me-1"></i>Add New Investment
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Existing Plans -->
            {% if existing_plans %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Plans for this Client
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for plan in existing_plans %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ plan.plan_name }}</h6>
                                <small class="text-muted">Created: {{ plan.created_at|date:"M d, Y" }}</small>
                            </div>
                            <span class="badge bg-{% if plan.status == 'approved' %}success{% elif plan.status == 'pending' %}warning{% else %}secondary{% endif %}">
                                {{ plan.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <!-- Add New Investment -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-search-plus me-2"></i>Add New Investment
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="schemeSearch" class="form-label">Search Schemes</label>
                        <input type="text" class="form-control" id="schemeSearch" 
                               placeholder="Type scheme name, AMC, or ISIN...">
                        <div id="schemeResults" class="mt-2"></div>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-lightbulb text-warning me-1"></i>
                        Search by scheme name, AMC name, or ISIN number to find mutual fund schemes
                    </div>
                    
                    <!-- Available SIP Schemes Count -->
                    {% if available_sip_schemes %}
                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            {{ available_sip_schemes.count }} schemes available for new SIP investments
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Plan Actions -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Plan Actions
                    </h6>
                    <button type="button" class="btn btn-light btn-sm" id="clearAllActions">
                        <i class="fas fa-trash me-1"></i>Clear All
                    </button>
                </div>
                <div class="card-body">
                    <div id="actionsContainer">
                        <div class="text-center text-muted py-4" id="noActionsMessage">
                            <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                            <h5>No Actions Added Yet</h5>
                            <p>Add actions from the portfolio or search for new schemes to get started.</p>
                        </div>
                    </div>
                    
                    <div id="actionsSummary" class="mt-3" style="display: none;">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Total Investment</h6>
                                    <span class="h5 text-success" id="totalInvestment">₹0</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Total Redemption</h6>
                                    <span class="h5 text-danger" id="totalRedemption">₹0</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Net Investment</h6>
                                    <span class="h5 text-primary" id="netInvestment">₹0</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Total Actions</h6>
                                    <span class="h5 text-info" id="totalActions">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Form Actions -->
    <div class="d-flex justify-content-between mb-4">
        <div>
            <a href="{% url 'create_plan' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
            <button type="button" class="btn btn-outline-info" id="saveTemplateBtn">
                <i class="fas fa-save me-2"></i>Save as Template
            </button>
        </div>
        <div>
            <button type="button" class="btn btn-success" id="saveDraftBtn">
                <i class="fas fa-save me-2"></i>Save as Draft
            </button>
            <button type="button" class="btn btn-primary" id="saveAndSubmitBtn">
                <i class="fas fa-paper-plane me-2"></i>Save & Submit for Approval
            </button>
        </div>
    </div>
</form>

<!-- Enhanced Portfolio Action Modal -->
<div class="modal fade" id="portfolioActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Portfolio Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="portfolioActionForm">
                    <input type="hidden" id="portfolioHoldingId">
                    <input type="hidden" id="actionPortfolioSchemeName">
                    
                    <div class="mb-3">
                        <label class="form-label">Scheme</label>
                        <div class="form-control-plaintext bg-light p-2 rounded" id="displayPortfolioSchemeName"></div>
                    </div>
                    
                    <!-- Action Type Selection with Icons -->
                    <div class="mb-3">
                        <label class="form-label">Action Type</label>
                        <div class="row" id="portfolioActionTypes">
                            {% for action_type in portfolio_action_types %}
                            <div class="col-md-6 mb-2">
                                <div class="card action-type-card" data-action-type="{{ action_type.type }}">
                                    <div class="card-body p-3 text-center">
                                        <i class="{{ action_type.icon }} fa-2x text-{{ action_type.color }} mb-2"></i>
                                        <h6 class="card-title">{{ action_type.name }}</h6>
                                        <small class="text-muted">{{ action_type.description }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="selectedActionType">
                    </div>
                    
                    <!-- Dynamic Action Options -->
                    <div id="actionOptionsContainer" style="display: none;">
                        <!-- Amount/Units Options -->
                        <div id="amountUnitsOptions">
                            <div class="mb-3">
                                <label class="form-label">Transaction Type</label>
                                <select class="form-control" id="transactionType">
                                    <option value="">Select transaction type...</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="portfolioActionAmount" class="form-label">Amount (₹)</label>
                                        <input type="number" class="form-control" id="portfolioActionAmount" 
                                               step="0.01" min="0" placeholder="Enter amount">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="portfolioActionUnits" class="form-label">Units</label>
                                        <input type="number" class="form-control" id="portfolioActionUnits" 
                                               step="0.0001" min="0" placeholder="Enter units">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SIP Specific Options -->
                        <div id="sipOptions" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sipAmount" class="form-label">SIP Amount (₹)</label>
                                        <input type="number" class="form-control" id="sipAmount" 
                                               step="100" min="500" placeholder="Enter SIP amount">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sipDate" class="form-label">SIP Date</label>
                                        <select class="form-control" id="sipDate">
                                            <option value="">Select date...</option>
                                            {% for i in "12345678901234567890123456789"|make_list %}
                                                {% if forloop.counter <= 28 %}
                                                    <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sipFrequency" class="form-label">Frequency</label>
                                        <select class="form-control" id="sipFrequency">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="fortnightly">Fortnightly</option>
                                            <option value="daily">Daily</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sipDuration" class="form-label">Duration (months)</label>
                                        <input type="number" class="form-control" id="sipDuration" 
                                               min="1" placeholder="Enter duration">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- STP/Switch Target Scheme -->
                        <div id="targetSchemeOptions" style="display: none;">
                            <div class="mb-3">
                                <label for="targetSchemeSearch" class="form-label">Target Scheme</label>
                                <input type="text" class="form-control" id="targetSchemeSearch" 
                                       placeholder="Search target scheme...">
                                <input type="hidden" id="targetSchemeId">
                                <div id="targetSchemeResults" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <!-- STP Specific Options -->
                        <div id="stpOptions" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stpAmount" class="form-label">STP Amount (₹)</label>
                                        <input type="number" class="form-control" id="stpAmount" 
                                               step="100" min="1000" placeholder="Enter STP amount">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stpFrequency" class="form-label">Frequency</label>
                                        <select class="form-control" id="stpFrequency">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SWP Specific Options -->
                        <div id="swpOptions" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="swpAmount" class="form-label">SWP Amount (₹)</label>
                                        <input type="number" class="form-control" id="swpAmount" 
                                               step="100" min="1000" placeholder="Enter SWP amount">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="swpFrequency" class="form-label">Frequency</label>
                                        <select class="form-control" id="swpFrequency">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Common Notes -->
                        <div class="mb-3">
                            <label for="portfolioActionNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="portfolioActionNotes" rows="2" 
                                      placeholder="Additional notes (optional)"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addPortfolioActionBtn">Add Action</button>
            </div>
        </div>
    </div>
</div>

<!-- Scheme Search Action Modal -->
<div class="modal fade" id="schemeActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Investment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="schemeActionForm">
                    <input type="hidden" id="newSchemeId">
                    <input type="hidden" id="newSchemeName">
                    
                    <div class="mb-3">
                        <label class="form-label">Selected Scheme</label>
                        <div class="form-control-plaintext bg-light p-2 rounded" id="displayNewSchemeName"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newInvestmentType" class="form-label">Investment Type</label>
                        <select class="form-control" id="newInvestmentType" required>
                            <option value="">Select investment type...</option>
                            <option value="lumpsum">Lump Sum Investment</option>
                            <option value="sip">Start SIP</option>
                        </select>
                    </div>
                    
                    <!-- Lump Sum Options -->
                    <div id="lumpsumOptions" style="display: none;">
                        <div class="mb-3">
                            <label for="lumpsumAmount" class="form-label">Investment Amount (₹)</label>
                            <input type="number" class="form-control" id="lumpsumAmount" 
                                   step="0.01" min="1000" placeholder="Enter investment amount">
                        </div>
                    </div>
                    
                    <!-- New SIP Options -->
                    <div id="newSipOptions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="newSipAmount" class="form-label">SIP Amount (₹)</label>
                                    <input type="number" class="form-control" id="newSipAmount" 
                                           step="100" min="500" placeholder="Enter SIP amount">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="newSipDate" class="form-label">SIP Date</label>
                                    <select class="form-control" id="newSipDate">
                                        <option value="">Select date...</option>
                                        {% for i in "12345678901234567890123456789"|make_list %}
                                            {% if forloop.counter <= 28 %}
                                                <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="newSipFrequency" class="form-label">Frequency</label>
                                    <select class="form-control" id="newSipFrequency">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="fortnightly">Fortnightly</option>
                                        <option value="daily">Daily</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="newSipDuration" class="form-label">Duration (months)</label>
                                    <input type="number" class="form-control" id="newSipDuration" 
                                           min="1" placeholder="Enter duration">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newInvestmentNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="newInvestmentNotes" rows="2" 
                                  placeholder="Additional notes (optional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addNewInvestmentBtn">Add Investment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced JavaScript for Portfolio Actions - Aligned with backend data structure

let planActions = [];
let actionCounter = 0;

// Portfolio action types from backend
const portfolioActionTypes = {{ portfolio_action_types|safe }};

$(document).ready(function() {
    initializeForm();
    calculatePercentages();
    
    // Portfolio view toggle
    $('#portfolioViewToggle').on('click', function() {
        const currentView = $(this).data('view');
        if (currentView === 'summary') {
            $(this).data('view', 'detailed').html('<i class="fas fa-list me-1"></i>Summary View');
        } else {
            $(this).data('view', 'summary').html('<i class="fas fa-table me-1"></i>Detailed View');
        }
    });

    // Portfolio action buttons
    $(document).on('click', '.portfolio-action-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const portfolioId = $(this).data('portfolio-id');
        const schemeName = $(this).data('scheme-name');
        const actionType = $(this).data('action');
        
        console.log('Portfolio action:', { portfolioId, schemeName, actionType });
        
        if (!portfolioId || !schemeName) {
            alert('Missing portfolio information. Please try again.');
            return;
        }
        
        openPortfolioActionModal(portfolioId, schemeName, actionType);
    });
    
    // Action type selection in modal
    $(document).on('click', '.action-type-card', function() {
        $('.action-type-card').removeClass('border-primary bg-light');
        $(this).addClass('border-primary bg-light');
        
        const actionType = $(this).data('action-type');
        $('#selectedActionType').val(actionType);
        
        showActionOptions(actionType);
    });
    
    // Investment type change for new schemes
    $('#newInvestmentType').on('change', function() {
        const investmentType = $(this).val();
        
        $('#lumpsumOptions, #newSipOptions').hide();
        
        if (investmentType === 'lumpsum') {
            $('#lumpsumOptions').show();
        } else if (investmentType === 'sip') {
            $('#newSipOptions').show();
        }
    });
    
    // Add portfolio action
    $('#addPortfolioActionBtn').on('click', function() {
        addPortfolioAction();
    });
    
    // Add new investment
    $('#addNewInvestmentBtn').on('click', function() {
        addNewInvestment();
    });
    
    // Scheme search
    let searchTimeout;
    $('#schemeSearch').on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            if (query.length >= 2) {
                searchSchemes(query);
            } else {
                $('#schemeResults').empty();
            }
        }, 300);
    });
    
    // Target scheme search
    $('#targetSchemeSearch').on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            if (query.length >= 2) {
                searchTargetSchemes(query);
            } else {
                $('#targetSchemeResults').empty();
            }
        }, 300);
    });
    
    // Template selector
    $('#templateSelect').on('change', function() {
        const templateId = $(this).val();
        if (templateId) {
            loadTemplate(templateId);
        }
    });
    
    // Clear all actions
    $('#clearAllActions').on('click', function() {
        if (planActions.length > 0 && confirm('Are you sure you want to clear all actions?')) {
            planActions = [];
            renderActions();
            updateSummary();
        }
    });
    
    // Save functions
    $('#saveDraftBtn').on('click', function() {
        savePlan('draft');
    });
    
    $('#saveAndSubmitBtn').on('click', function() {
        savePlan('submit');
    });
    
    $('#saveTemplateBtn').on('click', function() {
        saveAsTemplate();
    });
});

function initializeForm() {
    console.log('Form initialized with client:', '{{ client.id }}');
    console.log('Portfolio data count:', {{ portfolio_data|length|default:0 }});
}

function calculatePercentages() {
    const totalValue = {{ total_portfolio_value|default:0 }};
    
    if (totalValue > 0) {
        // Calculate percentages from asset allocation data
        {% if asset_allocation.total_equity %}
            const equityPct = ({{ asset_allocation.total_equity|default:0 }} / totalValue * 100).toFixed(1);
            $('#equity-percentage').text(equityPct + '%');
            $('.equity-pct').text(equityPct);
        {% else %}
            $('#equity-percentage').text('0%');
            $('.equity-pct').text('0');
        {% endif %}
        
        {% if asset_allocation.total_debt %}
            const debtPct = ({{ asset_allocation.total_debt|default:0 }} / totalValue * 100).toFixed(1);
            $('#debt-percentage').text(debtPct + '%');
            $('.debt-pct').text(debtPct);
        {% else %}
            $('#debt-percentage').text('0%');
            $('.debt-pct').text('0');
        {% endif %}
        
        {% if asset_allocation.total_hybrid %}
            const hybridPct = ({{ asset_allocation.total_hybrid|default:0 }} / totalValue * 100).toFixed(1);
            $('.hybrid-pct').text(hybridPct);
        {% else %}
            $('.hybrid-pct').text('0');
        {% endif %}
        
        {% if asset_allocation.total_liquid %}
            const liquidPct = ({{ asset_allocation.total_liquid|default:0 }} / totalValue * 100).toFixed(1);
            $('.liquid-pct').text(liquidPct);
        {% else %}
            $('.liquid-pct').text('0');
        {% endif %}
        
        {% if asset_allocation.total_other %}
            const otherPct = ({{ asset_allocation.total_other|default:0 }} / totalValue * 100).toFixed(1);
            $('.other-pct').text(otherPct);
        {% else %}
            $('.other-pct').text('0');
        {% endif %}
        
        {% if asset_allocation.total_arbitrage %}
            const arbitragePct = ({{ asset_allocation.total_arbitrage|default:0 }} / totalValue * 100).toFixed(1);
            $('.arbitrage-pct').text(arbitragePct);
        {% else %}
            $('.arbitrage-pct').text('0');
        {% endif %}
    } else {
        // Set all percentages to 0 if no total value
        $('#equity-percentage, #debt-percentage').text('0%');
        $('.equity-pct, .debt-pct, .hybrid-pct, .liquid-pct, .other-pct, .arbitrage-pct').text('0');
    }
}

function openPortfolioActionModal(portfolioId, schemeName, actionType) {
    // Reset form
    $('#portfolioActionForm')[0].reset();
    $('.action-type-card').removeClass('border-primary bg-light');
    $('#actionOptionsContainer').hide();
    
    // Set portfolio data
    $('#portfolioHoldingId').val(portfolioId);
    $('#actionPortfolioSchemeName').val(schemeName);
    $('#displayPortfolioSchemeName').text(schemeName);
    
    // Pre-select action type if provided
    if (actionType) {
        $(`.action-type-card[data-action-type="${actionType}"]`).addClass('border-primary bg-light');
        $('#selectedActionType').val(actionType);
        showActionOptions(actionType);
    }
    
    $('#portfolioActionModal').modal('show');
}

function showActionOptions(actionType) {
    // Hide all option containers
    $('#amountUnitsOptions, #sipOptions, #targetSchemeOptions, #stpOptions, #swpOptions').hide();
    $('#actionOptionsContainer').show();
    
    // Clear transaction type options
    $('#transactionType').empty().append('<option value="">Select transaction type...</option>');
    
    // Show relevant options based on action type
    switch(actionType) {
        case 'redeem':
            $('#amountUnitsOptions').show();
            populateTransactionOptions([
                {value: 'all_units', label: 'All Units'},
                {value: 'specific_amount', label: 'Specific Amount'},
                {value: 'specific_units', label: 'Specific Units'}
            ]);
            break;
            
        case 'switch':
            $('#amountUnitsOptions, #targetSchemeOptions').show();
            populateTransactionOptions([
                {value: 'all_units', label: 'All Units'},
                {value: 'specific_amount', label: 'Specific Amount'},
                {value: 'specific_units', label: 'Specific Units'}
            ]);
            break;
            
        case 'stp':
            $('#targetSchemeOptions, #stpOptions').show();
            break;
            
        case 'sip':
            $('#sipOptions').show();
            break;
            
        case 'swp':
            $('#swpOptions').show();
            break;
    }
}

function populateTransactionOptions(options) {
    const select = $('#transactionType');
    options.forEach(option => {
        select.append(`<option value="${option.value}">${option.label}</option>`);
    });
}

function searchSchemes(query) {
    console.log('Searching schemes for:', query);
    
    $('#schemeResults').html('<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>');
    
    // Simulated search - replace with actual AJAX call
    setTimeout(() => {
        displaySchemeResults([
            {
                id: 1,
                scheme_name: 'Sample Equity Fund',
                amc_name: 'Sample AMC',
                scheme_type: 'Equity',
                isin_number: 'INF123456789'
            }
        ]);
    }, 500);
}

function searchTargetSchemes(query) {
    console.log('Searching target schemes for:', query);
    
    $('#targetSchemeResults').html('<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>');
    
    // Simulated search - replace with actual AJAX call
    setTimeout(() => {
        displayTargetSchemeResults([
            {
                id: 2,
                scheme_name: 'Target Debt Fund',
                amc_name: 'Sample AMC',
                scheme_type: 'Debt'
            }
        ]);
    }, 500);
}

function displaySchemeResults(schemes) {
    const results = $('#schemeResults');
    results.empty();
    
    if (schemes && schemes.length > 0) {
        let resultsHtml = '<div class="list-group">';
        
        schemes.forEach(function(scheme) {
            resultsHtml += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center new-scheme-result" 
                     data-scheme-id="${scheme.id}" 
                     data-scheme-name="${scheme.scheme_name}">
                    <div>
                        <h6 class="mb-1">${scheme.scheme_name}</h6>
                        <small class="text-muted">${scheme.amc_name || 'Unknown AMC'} • ${scheme.scheme_type || 'Other'}</small>
                        ${scheme.isin_number ? `<br><small class="text-muted">ISIN: ${scheme.isin_number}</small>` : ''}
                    </div>
                    <button type="button" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
        });
        
        resultsHtml += '</div>';
        results.html(resultsHtml);
        
        // Add click handler for scheme selection
        $(document).on('click', '.new-scheme-result', function(e) {
            e.preventDefault();
            
            const schemeId = $(this).data('scheme-id');
            const schemeName = $(this).data('scheme-name');
            
            openNewInvestmentModal(schemeId, schemeName);
        });
        
    } else {
        results.html('<div class="text-muted text-center p-3">No schemes found. Try different search terms.</div>');
    }
}

function displayTargetSchemeResults(schemes) {
    const results = $('#targetSchemeResults');
    results.empty();
    
    if (schemes && schemes.length > 0) {
        let resultsHtml = '<div class="list-group">';
        
        schemes.forEach(function(scheme) {
            resultsHtml += `
                <div class="list-group-item list-group-item-action target-scheme-result" 
                     data-scheme-id="${scheme.id}" 
                     data-scheme-name="${scheme.scheme_name}">
                    <h6 class="mb-1">${scheme.scheme_name}</h6>
                    <small class="text-muted">${scheme.amc_name || 'Unknown AMC'} • ${scheme.scheme_type || 'Other'}</small>
                </div>
            `;
        });
        
        resultsHtml += '</div>';
        results.html(resultsHtml);
        
        // Add click handler for target scheme selection
        $(document).on('click', '.target-scheme-result', function(e) {
            e.preventDefault();
            
            const schemeId = $(this).data('scheme-id');
            const schemeName = $(this).data('scheme-name');
            
            $('#targetSchemeId').val(schemeId);
            $('#targetSchemeSearch').val(schemeName);
            $('#targetSchemeResults').empty();
        });
        
    } else {
        results.html('<div class="text-muted text-center p-3">No schemes found.</div>');
    }
}

function openNewInvestmentModal(schemeId, schemeName) {
    // Reset form
    $('#schemeActionForm')[0].reset();
    $('#lumpsumOptions, #newSipOptions').hide();
    
    // Set scheme data
    $('#newSchemeId').val(schemeId);
    $('#newSchemeName').val(schemeName);
    $('#displayNewSchemeName').text(schemeName);
    
    $('#schemeActionModal').modal('show');
}

function addPortfolioAction() {
    const actionType = $('#selectedActionType').val();
    
    if (!actionType) {
        alert('Please select an action type');
        return;
    }
    
    // Collect common data
    const actionData = {
        id: ++actionCounter,
        portfolio_id: $('#portfolioHoldingId').val(),
        scheme_name: $('#actionPortfolioSchemeName').val(),
        action_type: actionType,
        notes: $('#portfolioActionNotes').val()
    };
    
    // Collect specific data based on action type
    switch(actionType) {
        case 'redeem':
        case 'switch':
            actionData.transaction_type = $('#transactionType').val();
            actionData.amount = $('#portfolioActionAmount').val() ? parseFloat($('#portfolioActionAmount').val()) : null;
            actionData.units = $('#portfolioActionUnits').val() ? parseFloat($('#portfolioActionUnits').val()) : null;
            
            if (actionType === 'switch') {
                actionData.target_scheme_id = $('#targetSchemeId').val();
                actionData.target_scheme_name = $('#targetSchemeSearch').val();
            }
            break;
            
        case 'stp':
            actionData.target_scheme_id = $('#targetSchemeId').val();
            actionData.target_scheme_name = $('#targetSchemeSearch').val();
            actionData.amount = $('#stpAmount').val() ? parseFloat($('#stpAmount').val()) : null;
            actionData.frequency = $('#stpFrequency').val();
            break;
            
        case 'sip':
            actionData.amount = $('#sipAmount').val() ? parseFloat($('#sipAmount').val()) : null;
            actionData.sip_date = $('#sipDate').val();
            actionData.frequency = $('#sipFrequency').val();
            actionData.duration = $('#sipDuration').val() ? parseInt($('#sipDuration').val()) : null;
            break;
            
        case 'swp':
            actionData.amount = $('#swpAmount').val() ? parseFloat($('#swpAmount').val()) : null;
            actionData.frequency = $('#swpFrequency').val();
            break;
    }
    
    // Validate required fields
    if (!validateActionData(actionData)) {
        return;
    }
    
    // Add to plan actions
    planActions.push(actionData);
    
    // Update UI
    renderActions();
    updateSummary();
    
    // Close modal
    $('#portfolioActionModal').modal('hide');
    
    console.log('Added portfolio action:', actionData);
}

function addNewInvestment() {
    const investmentType = $('#newInvestmentType').val();
    
    if (!investmentType) {
        alert('Please select an investment type');
        return;
    }
    
    const actionData = {
        id: ++actionCounter,
        scheme_id: $('#newSchemeId').val(),
        scheme_name: $('#newSchemeName').val(),
        action_type: investmentType === 'lumpsum' ? 'purchase' : 'sip',
        notes: $('#newInvestmentNotes').val()
    };
    
    if (investmentType === 'lumpsum') {
        actionData.amount = $('#lumpsumAmount').val() ? parseFloat($('#lumpsumAmount').val()) : null;
    } else if (investmentType === 'sip') {
        actionData.amount = $('#newSipAmount').val() ? parseFloat($('#newSipAmount').val()) : null;
        actionData.sip_date = $('#newSipDate').val();
        actionData.frequency = $('#newSipFrequency').val();
        actionData.duration = $('#newSipDuration').val() ? parseInt($('#newSipDuration').val()) : null;
    }
    
    // Validate required fields
    if (!validateActionData(actionData)) {
        return;
    }
    
    // Add to plan actions
    planActions.push(actionData);
    
    // Update UI
    renderActions();
    updateSummary();
    
    // Close modal and clear search
    $('#schemeActionModal').modal('hide');
    $('#schemeSearch').val('');
    $('#schemeResults').empty();
    
    console.log('Added new investment:', actionData);
}

function validateActionData(actionData) {
    if (!actionData.amount && !actionData.units) {
        alert('Please enter either amount or units');
        return false;
    }
    
    if (['sip', 'stp', 'swp'].includes(actionData.action_type)) {
        if (!actionData.frequency) {
            alert('Please select frequency');
            return false;
        }
    }
    
    if (actionData.action_type === 'sip' && !actionData.sip_date) {
        alert('Please select SIP date');
        return false;
    }
    
    if (['switch', 'stp'].includes(actionData.action_type) && !actionData.target_scheme_name) {
        alert('Please select target scheme');
        return false;
    }
    
    return true;
}

function renderActions() {
    const container = $('#actionsContainer');
    
    if (planActions.length === 0) {
        $('#noActionsMessage').show();
        $('#actionsSummary').hide();
        container.find('.table-responsive').remove();
        return;
    }
    
    $('#noActionsMessage').hide();
    $('#actionsSummary').show();
    
    let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
    html += `
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Action</th>
                <th>Scheme</th>
                <th class="text-end">Amount</th>
                <th>Details</th>
                <th>Notes</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    planActions.forEach(function(action, index) {
        const actionTypeDisplay = getActionTypeDisplay(action.action_type);
        const actionClass = getActionTypeClass(action.action_type);
        
        html += `
            <tr>
                <td><span class="badge bg-secondary">${index + 1}</span></td>
                <td>
                    <span class="badge ${actionClass}">${actionTypeDisplay}</span>
                    ${action.frequency ? `<br><small class="text-muted">${action.frequency}</small>` : ''}
                </td>
                <td>
                    <div class="fw-bold text-primary">${action.scheme_name}</div>
                    ${action.target_scheme_name ? '<small class="text-muted"><i class="fas fa-arrow-right me-1"></i>' + action.target_scheme_name + '</small>' : ''}
                </td>
                <td class="text-end">
                    ${action.amount ? '<span class="fw-bold">₹' + parseFloat(action.amount).toLocaleString('en-IN') + '</span>' : '<span class="text-muted">-</span>'}
                    ${action.units ? '<br><small>' + parseFloat(action.units).toFixed(4) + ' units</small>' : ''}
                </td>
                <td>
                    ${getActionDetails(action)}
                </td>
                <td>
                    ${action.notes ? '<small>' + action.notes + '</small>' : '<span class="text-muted">-</span>'}
                </td>
                <td class="text-center">
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary edit-action-btn" 
                                data-index="${index}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-action-btn" 
                                data-index="${index}" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    // Remove existing table and add new one
    container.find('.table-responsive').remove();
    container.append(html);
    
    // Add event handlers
    $(document).off('click', '.remove-action-btn').on('click', '.remove-action-btn', function(e) {
        e.preventDefault();
        const index = $(this).data('index');
        if (confirm('Are you sure you want to remove this action?')) {
            planActions.splice(index, 1);
            renderActions();
            updateSummary();
        }
    });
    
    $(document).off('click', '.edit-action-btn').on('click', '.edit-action-btn', function(e) {
        e.preventDefault();
        const index = $(this).data('index');
        editAction(index);
    });
}

function getActionTypeDisplay(actionType) {
    const displayMap = {
        'purchase': 'Purchase',
        'redeem': 'Redeem',
        'switch': 'Switch',
        'stp': 'STP',
        'sip': 'SIP',
        'swp': 'SWP'
    };
    return displayMap[actionType] || actionType;
}

function getActionTypeClass(actionType) {
    const classMap = {
        'purchase': 'bg-success',
        'redeem': 'bg-danger',
        'switch': 'bg-info',
        'stp': 'bg-dark',
        'sip': 'bg-primary',
        'swp': 'bg-warning'
    };
    return classMap[actionType] || 'bg-secondary';
}

function getActionDetails(action) {
    let details = '';
    
    if (action.sip_date) {
        details += `<span class="badge bg-info">Date: ${action.sip_date}</span><br>`;
    }
    
    if (action.duration) {
        details += `<small class="text-muted">Duration: ${action.duration} months</small><br>`;
    }
    
    if (action.transaction_type) {
        details += `<small class="text-muted">Type: ${action.transaction_type.replace('_', ' ')}</small><br>`;
    }
    
    return details;
}

function editAction(index) {
    const action = planActions[index];
    
    console.log('Editing action:', action);
    
    // Determine if it's a portfolio action or new investment
    if (action.portfolio_id) {
        // Edit portfolio action
        openPortfolioActionModal(action.portfolio_id, action.scheme_name, action.action_type);
        
        // Populate form with existing data
        setTimeout(() => {
            populatePortfolioActionForm(action);
            $('#addPortfolioActionBtn').data('edit-index', index).text('Update Action');
        }, 100);
    } else {
        // Edit new investment
        openNewInvestmentModal(action.scheme_id, action.scheme_name);
        
        // Populate form with existing data
        setTimeout(() => {
            populateNewInvestmentForm(action);
            $('#addNewInvestmentBtn').data('edit-index', index).text('Update Investment');
        }, 100);
    }
}

function populatePortfolioActionForm(action) {
    if (action.amount) $('#portfolioActionAmount').val(action.amount);
    if (action.units) $('#portfolioActionUnits').val(action.units);
    if (action.transaction_type) $('#transactionType').val(action.transaction_type);
    if (action.target_scheme_id) {
        $('#targetSchemeId').val(action.target_scheme_id);
        $('#targetSchemeSearch').val(action.target_scheme_name);
    }
    if (action.sip_date) $('#sipDate').val(action.sip_date);
    if (action.frequency) {
        $('#sipFrequency, #stpFrequency, #swpFrequency').val(action.frequency);
    }
    if (action.duration) $('#sipDuration').val(action.duration);
    if (action.notes) $('#portfolioActionNotes').val(action.notes);
}

function populateNewInvestmentForm(action) {
    const investmentType = action.action_type === 'purchase' ? 'lumpsum' : 'sip';
    $('#newInvestmentType').val(investmentType).trigger('change');
    
    if (investmentType === 'lumpsum') {
        $('#lumpsumAmount').val(action.amount);
    } else {
        $('#newSipAmount').val(action.amount);
        $('#newSipDate').val(action.sip_date);
        $('#newSipFrequency').val(action.frequency);
        $('#newSipDuration').val(action.duration);
    }
    
    if (action.notes) $('#newInvestmentNotes').val(action.notes);
}

function updateSummary() {
    let totalInvestment = 0;
    let totalRedemption = 0;
    let sipCount = 0;
    
    planActions.forEach(function(action) {
        if (action.amount) {
            const amount = parseFloat(action.amount);
            
            if (['purchase', 'sip'].includes(action.action_type)) {
                totalInvestment += amount;
                if (action.action_type === 'sip') {
                    sipCount++;
                }
            } else if (['redeem', 'swp'].includes(action.action_type)) {
                totalRedemption += amount;
            }
        }
    });
    
    const netInvestment = totalInvestment - totalRedemption;
    
    $('#totalInvestment').text('₹' + totalInvestment.toLocaleString('en-IN'));
    $('#totalRedemption').text('₹' + totalRedemption.toLocaleString('en-IN'));
    $('#netInvestment').text('₹' + netInvestment.toLocaleString('en-IN'));
    $('#totalActions').text(planActions.length);
    
    // Update net investment color
    const netElement = $('#netInvestment');
    netElement.removeClass('text-success text-danger text-primary');
    if (netInvestment > 0) {
        netElement.addClass('text-success');
    } else if (netInvestment < 0) {
        netElement.addClass('text-danger');
    } else {
        netElement.addClass('text-primary');
    }
}

function savePlan(action) {
    const planName = $('#planName').val().trim();
    const description = $('#planDescription').val().trim();
    
    if (!planName) {
        alert('Please enter a plan name');
        $('#planName').focus();
        return;
    }
    
    if (planActions.length === 0) {
        alert('Please add at least one action to the plan');
        return;
    }
    
    // Show loading state
    const submitBtn = action === 'submit' ? $('#saveAndSubmitBtn') : $('#saveDraftBtn');
    const originalText = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');
    
    const data = {
        client_id: '{{ client.id }}',
        plan_name: planName,
        description: description,
        actions: planActions,
        submit_for_approval: action === 'submit'
    };
    
    console.log('Saving plan:', data);
    
    // Simulate save operation - replace with actual AJAX call
    setTimeout(() => {
        const message = action === 'submit' ? 
            'Plan saved and submitted for approval successfully!' : 
            'Plan saved as draft successfully!';
        
        alert(message);
        
        // Restore button state
        submitBtn.prop('disabled', false).html(originalText);
        
        // Redirect or update UI as needed
        // window.location.href = '/execution_plans/ongoing/';
    }, 1500);
}

function loadTemplate(templateId) {
    console.log('Loading template:', templateId);
    
    // Simulate template loading - replace with actual AJAX call
    setTimeout(() => {
        const sampleTemplate = [
            {
                id: 1,
                scheme_name: 'Template Equity Fund',
                action_type: 'sip',
                amount: 5000,
                sip_date: 5,
                frequency: 'monthly',
                notes: 'From template'
            }
        ];
        
        planActions = sampleTemplate;
        renderActions();
        updateSummary();
        alert('Template loaded successfully!');
    }, 500);
}

function saveAsTemplate() {
    const templateName = prompt('Enter template name:');
    if (!templateName) return;
    
    if (planActions.length === 0) {
        alert('Please add at least one action before saving as template');
        return;
    }
    
    console.log('Saving template:', templateName, planActions);
    
    // Simulate template saving - replace with actual AJAX call
    setTimeout(() => {
        alert('Template saved successfully!');
    }, 500);
}

function exportPortfolio() {
    const portfolioData = [];
    $('#portfolioTable tbody tr').each(function() {
        const row = $(this);
        portfolioData.push({
            scheme: row.find('td:eq(1)').text().trim(),
            value: row.find('td:eq(2)').text().trim(),
            units: row.find('td:eq(3)').text().trim(),
            assetClass: row.find('td:eq(4)').text().trim(),
            allocation: row.find('td:eq(5)').text().trim()
        });
    });
    
    // Simple CSV export
    let csv = 'Scheme,Current Value,Units,Asset Class,Allocation %\n';
    portfolioData.forEach(function(row) {
        csv += `"${row.scheme}","${row.value}","${row.units}","${row.assetClass}","${row.allocation}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ client.name }}_portfolio.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function addBulkActions() {
    alert('Bulk actions feature coming soon!');
}

</script>

<style>
.action-type-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.action-type-card:hover {
    border-color: #dee2e6;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.action-type-card.border-primary {
    border-color: #0d6efd !important;
    background-color: #f8f9fa !important;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.new-scheme-result:hover,
.target-scheme-result:hover {
    background-color: #e9ecef;
}

.table th {
    border-top: none;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}

.portfolio-summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.asset-allocation-breakdown {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
    }
    
    .table-responsive {
        max-height: 400px;
    }
}
</style>
{% endblock %}