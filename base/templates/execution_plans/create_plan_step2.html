<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Execution Plan - Step 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        .portfolio-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .portfolio-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .action-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .action-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }
        .client-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .scheme-search-result {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .scheme-search-result:hover {
            background-color: #f8f9fa;
        }
        .scheme-search-result:last-child {
            border-bottom: none;
        }
        .action-type-btn {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .action-type-btn.active {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .conditional-field {
            display: none;
        }
        .conditional-field.show {
            display: block;
        }
        .portfolio-summary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }
        .action-summary {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
        }
        .loading-spinner {
            display: none;
        }
        .scheme-tag {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px;
            display: inline-block;
        }
        .asset-allocation-bar {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #f0f0f0;
            margin: 10px 0;
        }
        .allocation-segment {
            height: 100%;
            display: inline-block;
            vertical-align: top;
        }
        .equity-segment { background-color: #28a745; }
        .debt-segment { background-color: #007bff; }
        .hybrid-segment { background-color: #ffc107; }
        .liquid-segment { background-color: #17a2b8; }
        .other-segment { background-color: #6f42c1; }
        .arbitrage-segment { background-color: #fd7e14; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0"><i class="fas fa-chart-line text-primary"></i> Create Execution Plan - Step 2</h2>
                        <p class="text-muted mb-0">Design portfolio actions for {{ client.name }}</p>
                    </div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'create_plan' %}">Select Client</a></li>
                            <li class="breadcrumb-item active">Design Plan</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Client Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card client-summary">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h4 class="mb-2"><i class="fas fa-user-circle"></i> {{ client.name }}</h4>
                                <p class="mb-1"><strong>PAN:</strong> {{ client.pan }}</p>
                                <p class="mb-1"><strong>Email:</strong> {{ client.email|default:"Not available" }}</p>
                                <p class="mb-0"><strong>Mobile:</strong> {{ client.mobile|default:"Not available" }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h5 class="mb-1">₹{{ portfolio_summary.combined_aum|floatformat:0 }}</h5>
                                        <small>Total AUM</small>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="mb-1">{{ portfolio_summary.total_schemes }}</h5>
                                        <small>Schemes</small>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="mb-1">{{ portfolio_summary.client_sip|floatformat:0 }}</h5>
                                        <small>SIP Amount</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Overview -->
        {% if has_portfolio_data %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-pie-chart text-success"></i> Current Portfolio</h5>
                        <span class="badge bg-success">{{ portfolio_summary.total_schemes }} Schemes</span>
                    </div>
                    <div class="card-body">
                        <!-- Asset Allocation Bar -->
                        {% if asset_allocation %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Asset Allocation (₹{{ asset_allocation.total_aum|floatformat:0 }})</label>
                            <div class="asset-allocation-bar" id="asset-allocation-bar">
                                <!-- Asset allocation will be calculated in JavaScript -->
                            </div>
                            <div class="row mt-2" id="asset-allocation-legend">
                                <!-- Legend will be populated by JavaScript -->
                            </div>
                        </div>
                        {% endif %}

                        <!-- Portfolio Holdings -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Scheme Name</th>
                                        <th class="text-end">Current Value</th>
                                        <th class="text-end">Units</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for holding in portfolio_data %}
                                    <tr data-portfolio-id="{{ holding.id }}" data-scheme-name="{{ holding.scheme_name }}" data-current-value="{{ holding.current_value }}" data-units="{{ holding.units }}">
                                        <td>
                                            <div>
                                                <strong>{{ holding.scheme_name|truncatechars:60 }}</strong>
                                                {% if holding.primary_asset_class %}
                                                <br><small class="text-muted">{{ holding.primary_asset_class }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <strong>₹{{ holding.current_value|floatformat:0 }}</strong>
                                            {% if holding.allocation_percentage %}
                                            <br><small class="text-muted">{{ holding.allocation_percentage|floatformat:2 }}%</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">{{ holding.units|floatformat:4 }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                {% if holding.can_redeem %}
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="openActionModal('redeem', '{{ holding.scheme_name|escapejs }}', {{ holding.current_value }}, {{ holding.units }}, {{ holding.id }})">
                                                    <i class="fas fa-minus-circle"></i> Redeem
                                                </button>
                                                {% endif %}
                                                {% if holding.can_switch %}
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openActionModal('switch', '{{ holding.scheme_name|escapejs }}', {{ holding.current_value }}, {{ holding.units }}, {{ holding.id }})">
                                                    <i class="fas fa-exchange-alt"></i> Switch
                                                </button>
                                                {% endif %}
                                                {% if holding.can_stp %}
                                                <button type="button" class="btn btn-sm btn-outline-info" onclick="openActionModal('stp', '{{ holding.scheme_name|escapejs }}', {{ holding.current_value }}, {{ holding.units }}, {{ holding.id }})">
                                                    <i class="fas fa-arrow-right"></i> STP
                                                </button>
                                                {% endif %}
                                                {% if holding.can_swp %}
                                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="openActionModal('swp', '{{ holding.scheme_name|escapejs }}', {{ holding.current_value }}, {{ holding.units }}, {{ holding.id }})">
                                                    <i class="fas fa-arrow-down"></i> SWP
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Planning Section -->
        <div class="row">
            <div class="col-md-8">
                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plus-circle text-success"></i> Add New Action</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-4">
                                <button type="button" class="btn btn-outline-success w-100 action-type-btn" onclick="openActionModal('sip', '', 0, 0, null)">
                                    <i class="fas fa-plus-circle fa-2x d-block mb-2"></i>
                                    <strong>New SIP</strong>
                                    <br><small>Regular Investment</small>
                                </button>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <button type="button" class="btn btn-outline-primary w-100 action-type-btn" onclick="openSchemeSearchModal()">
                                    <i class="fas fa-search fa-2x d-block mb-2"></i>
                                    <strong>Search Schemes</strong>
                                    <br><small>Find & Add Schemes</small>
                                </button>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <button type="button" class="btn btn-outline-info w-100 action-type-btn" onclick="loadTemplate()">
                                    <i class="fas fa-file-alt fa-2x d-block mb-2"></i>
                                    <strong>Use Template</strong>
                                    <br><small>Pre-defined Plans</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Planned Actions -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list-check text-primary"></i> Planned Actions</h5>
                        <span class="badge bg-primary" id="action-count">0 Actions</span>
                    </div>
                    <div class="card-body">
                        <div id="planned-actions">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <p>No actions planned yet. Start by adding actions from your portfolio or creating new investments.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Plan Summary -->
                <div class="card mb-4">
                    <div class="card-header portfolio-summary">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Plan Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <h6 class="text-success mb-1" id="total-investment">₹0</h6>
                                <small class="text-muted">Total Investment</small>
                            </div>
                            <div class="col-6">
                                <h6 class="text-danger mb-1" id="total-redemption">₹0</h6>
                                <small class="text-muted">Total Redemption</small>
                            </div>
                        </div>
                        <div class="text-center">
                            <h5 class="mb-1" id="net-investment">₹0</h5>
                            <small class="text-muted">Net Investment</small>
                        </div>
                        <hr>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="savePlan()" id="save-plan-btn" disabled>
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                            <button type="button" class="btn btn-primary" onclick="savePlan(true)" id="submit-plan-btn" disabled>
                                <i class="fas fa-paper-plane"></i> Save & Submit
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Quick Stats</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>SIP Actions:</span>
                            <span class="badge bg-success" id="sip-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Redemptions:</span>
                            <span class="badge bg-danger" id="redeem-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Switches:</span>
                            <span class="badge bg-primary" id="switch-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>STP/SWP:</span>
                            <span class="badge bg-info" id="systematic-count">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalLabel">Add Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="actionForm">
                        <input type="hidden" id="action-type" name="action_type">
                        <input type="hidden" id="portfolio-id" name="portfolio_id">
                        <input type="hidden" id="current-value" name="current_value">
                        <input type="hidden" id="current-units" name="current_units">

                        <!-- Action Type Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Action Type</label>
                            <div class="row g-2">
                                <div class="col-6 col-md-4">
                                    <button type="button" class="btn btn-outline-danger w-100 action-type-selector" data-action="redeem">
                                        <i class="fas fa-minus-circle"></i><br>Redeem
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100 action-type-selector" data-action="switch">
                                        <i class="fas fa-exchange-alt"></i><br>Switch
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button" class="btn btn-outline-info w-100 action-type-selector" data-action="stp">
                                        <i class="fas fa-arrow-right"></i><br>STP
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button" class="btn btn-outline-success w-100 action-type-selector" data-action="sip">
                                        <i class="fas fa-plus-circle"></i><br>SIP
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button" class="btn btn-outline-warning w-100 action-type-selector" data-action="swp">
                                        <i class="fas fa-arrow-down"></i><br>SWP
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Source Scheme -->
                        <div class="mb-3" id="source-scheme-group">
                            <label for="source-scheme" class="form-label fw-bold">Source Scheme</label>
                            <select class="form-select" id="source-scheme" name="source_scheme">
                                <option value="">Select source scheme</option>
                                {% for holding in portfolio_data %}
                                <option value="{{ holding.scheme_name }}" data-portfolio-id="{{ holding.id }}" data-current-value="{{ holding.current_value }}" data-units="{{ holding.units }}">
                                    {{ holding.scheme_name|truncatechars:60 }} (₹{{ holding.current_value|floatformat:0 }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Target Scheme (for Switch, STP, SIP) -->
                        <div class="mb-3 conditional-field" id="target-scheme-group">
                            <label for="target-scheme" class="form-label fw-bold">Target Scheme <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="target-scheme" name="target_scheme" placeholder="Search and select target scheme" readonly>
                                <button type="button" class="btn btn-outline-secondary" onclick="openSchemeSearch('target-scheme')">
                                    <i class="fas fa-search"></i> Browse Schemes
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> Click "Browse Schemes" to search from {{ all_schemes.count|default:"available" }} mutual fund schemes
                            </div>
                        </div>

                        <!-- Redeem By -->
                        <div class="mb-3 conditional-field" id="redeem-by-group">
                            <label for="redeem-by" class="form-label fw-bold">Redeem By</label>
                            <select class="form-select" id="redeem-by" name="redeem_by" onchange="toggleAmountField('redeem')">
                                <option value="">Select option</option>
                                <option value="all_units">All Units</option>
                                <option value="specific_amount">Specific Amount</option>
                                <option value="specific_units">Specific Units</option>
                            </select>
                        </div>

                        <!-- Switch By -->
                        <div class="mb-3 conditional-field" id="switch-by-group">
                            <label for="switch-by" class="form-label fw-bold">Switch By</label>
                            <select class="form-select" id="switch-by" name="switch_by" onchange="toggleAmountField('switch')">
                                <option value="">Select option</option>
                                <option value="all_units">All Units</option>
                                <option value="specific_amount">Specific Amount</option>
                                <option value="specific_units">Specific Units</option>
                            </select>
                        </div>

                        <!-- Amount Fields -->
                        <div class="mb-3 conditional-field" id="redeem-amount-group">
                            <label for="redeem-amount" class="form-label fw-bold">Redeem Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="redeem-amount" name="redeem_amount" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="mb-3 conditional-field" id="redeem-units-group">
                            <label for="redeem-units" class="form-label fw-bold">Redeem Units</label>
                            <input type="number" class="form-control" id="redeem-units" name="redeem_units" min="0" step="0.0001">
                        </div>

                        <div class="mb-3 conditional-field" id="switch-amount-group">
                            <label for="switch-amount" class="form-label fw-bold">Switch Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="switch-amount" name="switch_amount" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="mb-3 conditional-field" id="switch-units-group">
                            <label for="switch-units" class="form-label fw-bold">Switch Units</label>
                            <input type="number" class="form-control" id="switch-units" name="switch_units" min="0" step="0.0001">
                        </div>

                        <!-- STP Fields -->
                        <div class="mb-3 conditional-field" id="stp-amount-group">
                            <label for="stp-amount" class="form-label fw-bold">STP Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="stp-amount" name="stp_amount" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="mb-3 conditional-field" id="stp-frequency-group">
                            <label for="stp-frequency" class="form-label fw-bold">STP Frequency</label>
                            <select class="form-select" id="stp-frequency" name="stp_frequency">
                                <option value="">Select frequency</option>
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>

                        <!-- SIP Fields -->
                        <div class="mb-3 conditional-field" id="sip-amount-group">
                            <label for="sip-amount" class="form-label fw-bold">SIP Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="sip-amount" name="sip_amount" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="mb-3 conditional-field" id="sip-frequency-group">
                            <label for="sip-frequency" class="form-label fw-bold">SIP Frequency</label>
                            <select class="form-select" id="sip-frequency" name="sip_frequency">
                                <option value="">Select frequency</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="fortnightly">Fortnightly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="mb-3 conditional-field" id="sip-date-group">
                            <label for="sip-date" class="form-label fw-bold">SIP Date</label>
                            <select class="form-select" id="sip-date" name="sip_date">
                                <option value="">Select date</option>
                                {% for i in "12345678901234567890123456789012345678901234567890" %}
                                {% if forloop.counter <= 31 %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- SWP Fields -->
                        <div class="mb-3 conditional-field" id="swp-amount-group">
                            <label for="swp-amount" class="form-label fw-bold">SWP Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="swp-amount" name="swp_amount" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="mb-3 conditional-field" id="swp-frequency-group">
                            <label for="swp-frequency" class="form-label fw-bold">SWP Frequency</label>
                            <select class="form-select" id="swp-frequency" name="swp_frequency">
                                <option value="">Select frequency</option>
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>

                        <div class="mb-3 conditional-field" id="swp-date-group">
                            <label for="swp-date" class="form-label fw-bold">SWP Date</label>
                            <select class="form-select" id="swp-date" name="swp_date">
                                <option value="">Select date</option>
                                {% for i in "12345678901234567890123456789012345678901234567890" %}
                                {% if forloop.counter <= 31 %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="action-notes" class="form-label fw-bold">Notes (Optional)</label>
                            <textarea class="form-control" id="action-notes" name="notes" rows="2" placeholder="Add any additional notes or instructions"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addAction()">Add Action</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheme Search Modal -->
    <div class="modal fade" id="schemeSearchModal" tabindex="-1" aria-labelledby="schemeSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="schemeSearchModalLabel">Search Mutual Fund Schemes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="scheme-search-input" placeholder="Search by scheme name, AMC, ISIN, or category..." autocomplete="off">
                            <button type="button" class="btn btn-primary" onclick="searchSchemes()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-database"></i> Searching from {{ all_schemes.count|default:"available" }} mutual fund schemes in database
                        </div>
                    </div>
                    
                    <div id="scheme-search-results">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-3"></i>
                            <p>Enter at least 2 characters to search for schemes</p>
                        </div>
                    </div>
                    
                    <div class="loading-spinner text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Searching schemes...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Name Modal -->
    <div class="modal fade" id="planNameModal" tabindex="-1" aria-labelledby="planNameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planNameModalLabel">Save Execution Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="planNameForm">
                        <div class="mb-3">
                            <label for="plan-name" class="form-label fw-bold">Plan Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="plan-name" name="plan_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="plan-description" class="form-label fw-bold">Description</label>
                            <textarea class="form-control" id="plan-description" name="description" rows="3" placeholder="Optional description of the execution plan"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitPlan(false)" id="save-draft-btn">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitPlan(true)" id="submit-approval-btn">
                        <i class="fas fa-paper-plane"></i> Save & Submit for Approval
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // Global variables
        let plannedActions = [];
        let currentTargetField = null;
        
        // Initialize when page loads
        $(document).ready(function() {
            updateActionsSummary();
            initializeAssetAllocation();
            
            // Setup scheme search on enter key
            $('#scheme-search-input').on('keypress', function(e) {
                if (e.which === 13) {
                    searchSchemes();
                }
            });
            
            // Setup action type selection
            $('.action-type-selector').on('click', function() {
                const actionType = $(this).data('action');
                selectActionType(actionType);
            });
        });

        // Initialize asset allocation visualization
        function initializeAssetAllocation() {
            {% if asset_allocation %}
            const allocation = {
                total_aum: {{ asset_allocation.total_aum|default:0 }},
                total_equity: {{ asset_allocation.total_equity|default:0 }},
                total_debt: {{ asset_allocation.total_debt|default:0 }},
                total_hybrid: {{ asset_allocation.total_hybrid|default:0 }},
                total_liquid: {{ asset_allocation.total_liquid|default:0 }},
                total_other: {{ asset_allocation.total_other|default:0 }},
                total_arbitrage: {{ asset_allocation.total_arbitrage|default:0 }}
            };
            
            if (allocation.total_aum > 0) {
                displayAssetAllocation(allocation);
            }
            {% endif %}
        }

        function displayAssetAllocation(allocation) {
            const barContainer = $('#asset-allocation-bar');
            const legendContainer = $('#asset-allocation-legend');
            
            let barHtml = '';
            let legendHtml = '';
            
            const segments = [
                { name: 'Equity', value: allocation.total_equity, class: 'equity-segment' },
                { name: 'Debt', value: allocation.total_debt, class: 'debt-segment' },
                { name: 'Hybrid', value: allocation.total_hybrid, class: 'hybrid-segment' },
                { name: 'Liquid', value: allocation.total_liquid, class: 'liquid-segment' },
                { name: 'Other', value: allocation.total_other, class: 'other-segment' },
                { name: 'Arbitrage', value: allocation.total_arbitrage, class: 'arbitrage-segment' }
            ];
            
            segments.forEach(segment => {
                if (segment.value > 0) {
                    const percentage = (segment.value / allocation.total_aum) * 100;
                    
                    // Add to bar
                    barHtml += `<div class="allocation-segment ${segment.class}" style="width: ${percentage}%"></div>`;
                    
                    // Add to legend
                    legendHtml += `
                        <div class="col-2">
                            <span class="${segment.class} d-inline-block" style="width: 12px; height: 12px; border-radius: 2px;"></span> 
                            ${segment.name}: ₹${segment.value.toLocaleString()}
                        </div>
                    `;
                }
            });
            
            barContainer.html(barHtml);
            legendContainer.html(legendHtml);
        }

        // Action Modal Functions
        function openActionModal(actionType, schemeName = '', currentValue = 0, currentUnits = 0, portfolioId = null) {
            resetActionForm();
            
            // Set initial values
            $('#action-type').val(actionType);
            $('#current-value').val(currentValue);
            $('#current-units').val(currentUnits);
            $('#portfolio-id').val(portfolioId);
            
            // Set source scheme if provided
            if (schemeName) {
                $('#source-scheme').val(schemeName);
                // Update the portfolio data when source scheme is selected
                updatePortfolioData(schemeName);
            }
            
            // Select action type
            selectActionType(actionType);
            
            // Set modal title
            const actionTitles = {
                'redeem': 'Redeem Investment',
                'switch': 'Switch Investment', 
                'stp': 'Systematic Transfer Plan',
                'sip': 'Systematic Investment Plan',
                'swp': 'Systematic Withdrawal Plan'
            };
            $('#actionModalLabel').text(actionTitles[actionType] || 'Add Action');
            
            // Show modal
            $('#actionModal').modal('show');
        }

        function updatePortfolioData(schemeName) {
            // Find the selected option and update hidden fields
            const selectedOption = $(`#source-scheme option[value="${schemeName}"]`);
            if (selectedOption.length > 0) {
                $('#portfolio-id').val(selectedOption.data('portfolio-id'));
                $('#current-value').val(selectedOption.data('current-value'));
                $('#current-units').val(selectedOption.data('units'));
            }
        }

        // Add event listener for source scheme selection
        $(document).ready(function() {
            $('#source-scheme').on('change', function() {
                const selectedScheme = $(this).val();
                if (selectedScheme) {
                    updatePortfolioData(selectedScheme);
                }
            });
        });

        function selectActionType(actionType) {
            // Reset all buttons
            $('.action-type-selector').removeClass('active btn-danger btn-primary btn-info btn-success btn-warning')
                .addClass('btn-outline-danger btn-outline-primary btn-outline-info btn-outline-success btn-outline-warning');
            
            // Activate selected button
            $(`.action-type-selector[data-action="${actionType}"]`)
                .removeClass('btn-outline-danger btn-outline-primary btn-outline-info btn-outline-success btn-outline-warning')
                .addClass('active');
            
            // Apply appropriate color
            const colorMap = {
                'redeem': 'btn-danger',
                'switch': 'btn-primary',
                'stp': 'btn-info',
                'sip': 'btn-success',
                'swp': 'btn-warning'
            };
            $(`.action-type-selector[data-action="${actionType}"]`).addClass(colorMap[actionType]);
            
            // Set hidden field
            $('#action-type').val(actionType);
            
            // Show/hide relevant fields
            showRelevantFields(actionType);
        }

        function showRelevantFields(actionType) {
            // Hide all conditional fields
            $('.conditional-field').removeClass('show');
            
            // Show common fields based on action type
            switch(actionType) {
                case 'redeem':
                    $('#redeem-by-group').addClass('show');
                    $('#source-scheme-group').show();
                    break;
                case 'switch':
                    $('#target-scheme-group, #switch-by-group').addClass('show');
                    $('#source-scheme-group').show();
                    break;
                case 'stp':
                    $('#target-scheme-group, #stp-amount-group, #stp-frequency-group').addClass('show');
                    $('#source-scheme-group').show();
                    break;
                case 'sip':
                    $('#target-scheme-group, #sip-amount-group, #sip-frequency-group, #sip-date-group').addClass('show');
                    $('#source-scheme-group').hide(); // SIP doesn't need source scheme
                    $('#source-scheme').val(''); // Clear source scheme for SIP
                    break;
                case 'swp':
                    $('#swp-amount-group, #swp-frequency-group, #swp-date-group').addClass('show');
                    $('#source-scheme-group').show();
                    break;
            }
        }

        function toggleAmountField(type) {
            const selectedValue = $(`#${type}-by`).val();
            
            // Hide all amount/unit fields for this type
            $(`#${type}-amount-group, #${type}-units-group`).removeClass('show');
            
            // Show relevant field based on selection
            if (selectedValue === 'specific_amount') {
                $(`#${type}-amount-group`).addClass('show');
            } else if (selectedValue === 'specific_units') {
                $(`#${type}-units-group`).addClass('show');
            }
        }

        function resetActionForm() {
            $('#actionForm')[0].reset();
            $('.conditional-field').removeClass('show');
            $('.action-type-selector').removeClass('active btn-danger btn-primary btn-info btn-success btn-warning')
                .addClass('btn-outline-danger btn-outline-primary btn-outline-info btn-outline-success btn-outline-warning');
        }

        // Scheme Search Functions
        function openSchemeSearchModal() {
            $('#schemeSearchModal').modal('show');
        }

        function openSchemeSearch(targetFieldId) {
            currentTargetField = targetFieldId;
            $('#schemeSearchModal').modal('show');
        }

        function searchSchemes() {
            const query = $('#scheme-search-input').val().trim();
            
            if (query.length < 2) {
                alert('Please enter at least 2 characters to search');
                return;
            }
            
            // Show loading spinner
            $('.loading-spinner').show();
            $('#scheme-search-results').hide();
            
            // Make AJAX request to search schemes
            $.ajax({
                url: '{% url "search_schemes_ajax" %}',
                method: 'GET',
                data: { q: query },
                success: function(response) {
                    $('.loading-spinner').hide();
                    $('#scheme-search-results').show();
                    
                    if (response.success && response.schemes.length > 0) {
                        displaySchemeResults(response.schemes);
                    } else {
                        $('#scheme-search-results').html(`
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-3"></i>
                                <p>No schemes found for "${query}"</p>
                            </div>
                        `);
                    }
                },
                error: function() {
                    $('.loading-spinner').hide();
                    $('#scheme-search-results').show().html(`
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error searching schemes. Please try again.</p>
                        </div>
                    `);
                }
            });
        }

        function displaySchemeResults(schemes) {
            let html = '<div class="list-group">';
            
            schemes.forEach(function(scheme) {
                // Handle the exact structure from your MutualFundScheme model
                const schemeName = scheme.scheme_name || '';
                const amcName = scheme.amc_name || 'Unknown AMC';
                const category = scheme.category || 'Unknown Category';
                const schemeType = scheme.scheme_type || 'other';
                const riskCategory = scheme.risk_category || 'moderate';
                const minInvestment = scheme.minimum_investment || 500;
                const minSip = scheme.minimum_sip || 500;
                
                // ISIN Information
                const isinGrowth = scheme.isin_growth || '';
                const isinDiv = scheme.isin_div_reinvestment || '';
                
                // NAV Information
                const lastNavPrice = scheme.last_nav_price ? parseFloat(scheme.last_nav_price).toFixed(4) : null;
                const lastNavDate = scheme.last_nav_date || '';
                
                // Status and availability
                const isActive = scheme.is_active !== false;
                const sipAvailable = scheme.sip_available !== false;
                const stpAvailable = scheme.stp_available !== false;
                const swpAvailable = scheme.swp_available !== false;
                
                // Color coding based on scheme type
                const typeColors = {
                    'equity': 'success',
                    'debt': 'primary', 
                    'hybrid': 'warning',
                    'liquid': 'info',
                    'ultra_short': 'info',
                    'elss': 'success',
                    'index': 'secondary',
                    'etf': 'dark',
                    'arbitrage': 'danger',
                    'other': 'secondary'
                };
                
                const riskColors = {
                    'low': 'success',
                    'moderate': 'warning',
                    'high': 'danger',
                    'very_high': 'danger'
                };
                
                const typeColor = typeColors[schemeType] || 'secondary';
                const riskColor = riskColors[riskCategory] || 'warning';
                
                html += `
                    <div class="scheme-search-result list-group-item list-group-item-action" onclick="selectScheme('${schemeName.replace(/'/g, "\\'")}', '${amcName.replace(/'/g, "\\'")}', '${scheme.id}', '${scheme.scheme_code || ''}')">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h6 class="mb-0 text-primary flex-grow-1">${schemeName}</h6>
                                    <div class="ms-2">
                                        ${isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>'}
                                    </div>
                                </div>
                                
                                <div class="row mb-2">
                                    <div class="col-md-8">
                                        <p class="mb-1">
                                            <strong>AMC:</strong> ${amcName}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Category:</strong> ${category}
                                            <span class="badge bg-${typeColor} ms-2">${schemeType.toUpperCase()}</span>
                                            <span class="badge bg-${riskColor} ms-1">${riskCategory.replace('_', ' ').toUpperCase()}</span>
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        ${lastNavPrice ? `<div class="text-success"><strong>NAV:</strong> ₹${lastNavPrice}</div>` : ''}
                                        ${lastNavDate ? `<small class="text-muted">${lastNavDate}</small>` : ''}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        ${isinGrowth ? `<small class="text-muted d-block"><strong>ISIN Growth:</strong> ${isinGrowth}</small>` : ''}
                                        ${isinDiv ? `<small class="text-muted d-block"><strong>ISIN Div Reinv:</strong> ${isinDiv}</small>` : ''}
                                        ${scheme.scheme_code ? `<small class="text-muted d-block"><strong>Code:</strong> ${scheme.scheme_code}</small>` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block"><strong>Min Investment:</strong> ₹${minInvestment.toLocaleString()}</small>
                                        <small class="text-muted d-block"><strong>Min SIP:</strong> ₹${minSip.toLocaleString()}</small>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    ${sipAvailable ? '<span class="badge bg-success me-1"><i class="fas fa-check"></i> SIP Available</span>' : ''}
                                    ${stpAvailable ? '<span class="badge bg-info me-1"><i class="fas fa-check"></i> STP Available</span>' : ''}
                                    ${swpAvailable ? '<span class="badge bg-warning me-1"><i class="fas fa-check"></i> SWP Available</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            $('#scheme-search-results').html(html);
        }

        function selectScheme(schemeName, amcName, schemeId, schemeCode) {
            const fullSchemeName = schemeName;
            
            if (currentTargetField) {
                // If target field is specified, populate that field
                $(`#${currentTargetField}`).val(fullSchemeName);
                $(`#${currentTargetField}`).attr('data-scheme-id', schemeId);
                $(`#${currentTargetField}`).attr('data-scheme-code', schemeCode);
                $(`#${currentTargetField}`).attr('data-amc-name', amcName);
                
                // Store additional scheme data for validation
                const selectedScheme = window.lastSearchResults?.find(s => s.id == schemeId);
                if (selectedScheme) {
                    $(`#${currentTargetField}`).attr('data-min-investment', selectedScheme.minimum_investment || 500);
                    $(`#${currentTargetField}`).attr('data-min-sip', selectedScheme.minimum_sip || 500);
                    $(`#${currentTargetField}`).attr('data-scheme-type', selectedScheme.scheme_type || 'other');
                    $(`#${currentTargetField}`).attr('data-risk-category', selectedScheme.risk_category || 'moderate');
                }
                
                currentTargetField = null;
            } else {
                // If no target field, assume it's for SIP action
                openActionModal('sip', '', 0, 0, null);
                $('#target-scheme').val(fullSchemeName);
                $('#target-scheme').attr('data-scheme-id', schemeId);
                $('#target-scheme').attr('data-scheme-code', schemeCode);
                $('#target-scheme').attr('data-amc-name', amcName);
            }
            
            $('#schemeSearchModal').modal('hide');
        }

        // Store search results globally for scheme selection
        function searchSchemes() {
            const query = $('#scheme-search-input').val().trim();
            
            if (query.length < 2) {
                alert('Please enter at least 2 characters to search');
                return;
            }
            
            // Show loading spinner
            $('.loading-spinner').show();
            $('#scheme-search-results').hide();
            
            // Make AJAX request to search schemes
            $.ajax({
                url: '{% url "search_schemes_ajax" %}',
                method: 'GET',
                data: { q: query },
                success: function(response) {
                    $('.loading-spinner').hide();
                    $('#scheme-search-results').show();
                    
                    if (response.success && response.schemes.length > 0) {
                        // Store results globally for scheme selection
                        window.lastSearchResults = response.schemes;
                        displaySchemeResults(response.schemes);
                    } else {
                        $('#scheme-search-results').html(`
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-3"></i>
                                <p>No schemes found for "${query}"</p>
                                <small>Try searching with different keywords like AMC name, scheme type, or category</small>
                            </div>
                        `);
                    }
                },
                error: function() {
                    $('.loading-spinner').hide();
                    $('#scheme-search-results').show().html(`
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error searching schemes. Please try again.</p>
                        </div>
                    `);
                }
            });
        }

        // Action Management Functions
        function addAction() {
            const formData = new FormData($('#actionForm')[0]);
            const actionType = formData.get('action_type');
            
            // Validate required fields
            if (!validateActionForm(actionType, formData)) {
                return;
            }
            
            // Create action object
            const action = createActionObject(formData);
            
            // Add to planned actions
            plannedActions.push(action);
            
            // Update UI
            displayPlannedActions();
            updateActionsSummary();
            
            // Close modal
            $('#actionModal').modal('hide');
        }

        function validateActionForm(actionType, formData) {
            let isValid = true;
            let errorMessage = '';
            
            switch(actionType) {
                case 'redeem':
                    if (!formData.get('source_scheme')) {
                        errorMessage = 'Please select a source scheme';
                        isValid = false;
                    } else if (!formData.get('redeem_by')) {
                        errorMessage = 'Please select redeem method';
                        isValid = false;
                    } else if (formData.get('redeem_by') === 'specific_amount' && !formData.get('redeem_amount')) {
                        errorMessage = 'Redeem amount is required';
                        isValid = false;
                    } else if (formData.get('redeem_by') === 'specific_units' && !formData.get('redeem_units')) {
                        errorMessage = 'Redeem units is required';
                        isValid = false;
                    }
                    break;
                    
                case 'switch':
                    if (!formData.get('source_scheme')) {
                        errorMessage = 'Please select a source scheme';
                        isValid = false;
                    } else if (!formData.get('target_scheme')) {
                        errorMessage = 'Target scheme is required. Please search and select a scheme.';
                        isValid = false;
                    } else if (!formData.get('switch_by')) {
                        errorMessage = 'Please select switch method';
                        isValid = false;
                    } else if (formData.get('switch_by') === 'specific_amount' && !formData.get('switch_amount')) {
                        errorMessage = 'Switch amount is required';
                        isValid = false;
                    } else if (formData.get('switch_by') === 'specific_units' && !formData.get('switch_units')) {
                        errorMessage = 'Switch units is required';
                        isValid = false;
                    } else {
                        // Validate minimum investment for switch
                        const minInvestment = parseFloat($('#target-scheme').attr('data-min-investment')) || 500;
                        const switchAmount = parseFloat(formData.get('switch_amount'));
                        if (formData.get('switch_by') === 'specific_amount' && switchAmount < minInvestment) {
                            errorMessage = `Switch amount must be at least ₹${minInvestment.toLocaleString()} for the selected scheme`;
                            isValid = false;
                        }
                    }
                    break;
                    
                case 'stp':
                    if (!formData.get('source_scheme')) {
                        errorMessage = 'Please select a source scheme';
                        isValid = false;
                    } else if (!formData.get('target_scheme')) {
                        errorMessage = 'Target scheme is required. Please search and select a scheme.';
                        isValid = false;
                    } else if (!formData.get('stp_amount')) {
                        errorMessage = 'STP amount is required';
                        isValid = false;
                    } else if (!formData.get('stp_frequency')) {
                        errorMessage = 'STP frequency is required';
                        isValid = false;
                    } else {
                        // Validate minimum STP amount (usually minimum investment amount)
                        const minInvestment = parseFloat($('#target-scheme').attr('data-min-investment')) || 500;
                        const stpAmount = parseFloat(formData.get('stp_amount'));
                        if (stpAmount < minInvestment) {
                            errorMessage = `STP amount must be at least ₹${minInvestment.toLocaleString()} for the selected scheme`;
                            isValid = false;
                        }
                    }
                    break;
                    
                case 'sip':
                    if (!formData.get('target_scheme')) {
                        errorMessage = 'Target scheme is required. Please search and select a scheme.';
                        isValid = false;
                    } else if (!formData.get('sip_amount')) {
                        errorMessage = 'SIP amount is required';
                        isValid = false;
                    } else if (!formData.get('sip_frequency')) {
                        errorMessage = 'SIP frequency is required';
                        isValid = false;
                    } else if (!formData.get('sip_date')) {
                        errorMessage = 'SIP date is required';
                        isValid = false;
                    } else {
                        // Validate minimum SIP amount
                        const minSip = parseFloat($('#target-scheme').attr('data-min-sip')) || 500;
                        const sipAmount = parseFloat(formData.get('sip_amount'));
                        if (sipAmount < minSip) {
                            errorMessage = `SIP amount must be at least ₹${minSip.toLocaleString()} for the selected scheme`;
                            isValid = false;
                        }
                    }
                    break;
                    
                case 'swp':
                    if (!formData.get('source_scheme')) {
                        errorMessage = 'Please select a source scheme';
                        isValid = false;
                    } else if (!formData.get('swp_amount')) {
                        errorMessage = 'SWP amount is required';
                        isValid = false;
                    } else if (!formData.get('swp_frequency')) {
                        errorMessage = 'SWP frequency is required';
                        isValid = false;
                    } else if (!formData.get('swp_date')) {
                        errorMessage = 'SWP date is required';
                        isValid = false;
                    }
                    break;
            }
            
            if (!isValid) {
                alert(errorMessage);
            }
            
            return isValid;
        }

        function createActionObject(formData) {
            const actionType = formData.get('action_type');
            const action = {
                id: Date.now() + Math.random(), // Unique ID
                action_type: actionType,
                source_scheme: formData.get('source_scheme') || '',
                target_scheme: formData.get('target_scheme') || '',
                notes: formData.get('notes') || '',
                portfolio_id: formData.get('portfolio_id') || null,
                // Add scheme IDs and codes for backend processing
                source_scheme_id: $('#source-scheme option:selected').data('portfolio-id') || null,
                target_scheme_id: $('#target-scheme').attr('data-scheme-id') || null,
                target_scheme_code: $('#target-scheme').attr('data-scheme-code') || null,
                // Add minimum investment validation data
                target_scheme_min_investment: $('#target-scheme').attr('data-min-investment') || null,
                target_scheme_min_sip: $('#target-scheme').attr('data-min-sip') || null
            };
            
            // Add type-specific fields with validation
            switch(actionType) {
                case 'redeem':
                    action.redeem_by = formData.get('redeem_by');
                    action.redeem_amount = formData.get('redeem_amount');
                    action.redeem_units = formData.get('redeem_units');
                    break;
                case 'switch':
                    action.switch_by = formData.get('switch_by');
                    action.switch_amount = formData.get('switch_amount');
                    action.switch_units = formData.get('switch_units');
                    break;
                case 'stp':
                    action.stp_amount = formData.get('stp_amount');
                    action.stp_frequency = formData.get('stp_frequency');
                    break;
                case 'sip':
                    action.sip_amount = formData.get('sip_amount');
                    action.sip_frequency = formData.get('sip_frequency');
                    action.sip_date = formData.get('sip_date');
                    break;
                case 'swp':
                    action.swp_amount = formData.get('swp_amount');
                    action.swp_frequency = formData.get('swp_frequency');
                    action.swp_date = formData.get('swp_date');
                    break;
            }
            
            return action;
        }

        function displayPlannedActions() {
            const container = $('#planned-actions');
            
            if (plannedActions.length === 0) {
                container.html(`
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <p>No actions planned yet. Start by adding actions from your portfolio or creating new investments.</p>
                    </div>
                `);
                return;
            }
            
            let html = '';
            plannedActions.forEach(function(action, index) {
                html += createActionCard(action, index);
            });
            
            container.html(html);
        }

        function createActionCard(action, index) {
            const actionTypeColors = {
                'redeem': 'danger',
                'switch': 'primary',
                'stp': 'info',
                'sip': 'success',
                'swp': 'warning'
            };
            
            const actionTypeIcons = {
                'redeem': 'fas fa-minus-circle',
                'switch': 'fas fa-exchange-alt',
                'stp': 'fas fa-arrow-right',
                'sip': 'fas fa-plus-circle',
                'swp': 'fas fa-arrow-down'
            };
            
            const color = actionTypeColors[action.action_type] || 'secondary';
            const icon = actionTypeIcons[action.action_type] || 'fas fa-cog';
            
            return `
                <div class="card action-card mb-3" data-action-index="${index}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title">
                                    <i class="${icon} text-${color}"></i>
                                    ${action.action_type.toUpperCase()}
                                    <span class="badge bg-${color} ms-2">${index + 1}</span>
                                </h6>
                                <div class="action-details">
                                    ${formatActionDetails(action)}
                                </div>
                                ${action.notes ? `<small class="text-muted"><i class="fas fa-sticky-note"></i> ${action.notes}</small>` : ''}
                            </div>
                            <div class="action-controls">
                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="editAction(${index})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAction(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatActionDetails(action) {
            let details = '';
            
            switch(action.action_type) {
                case 'redeem':
                    details = `<strong>From:</strong> ${action.source_scheme}<br>`;
                    if (action.redeem_by === 'all_units') {
                        details += '<strong>Amount:</strong> All Units';
                    } else if (action.redeem_by === 'specific_amount') {
                        details += `<strong>Amount:</strong> ₹${parseFloat(action.redeem_amount).toLocaleString()}`;
                    } else if (action.redeem_by === 'specific_units') {
                        details += `<strong>Units:</strong> ${parseFloat(action.redeem_units).toLocaleString()}`;
                    }
                    break;
                    
                case 'switch':
                    details = `<strong>From:</strong> ${action.source_scheme}<br>`;
                    details += `<strong>To:</strong> ${action.target_scheme}<br>`;
                    if (action.switch_by === 'all_units') {
                        details += '<strong>Amount:</strong> All Units';
                    } else if (action.switch_by === 'specific_amount') {
                        details += `<strong>Amount:</strong> ₹${parseFloat(action.switch_amount).toLocaleString()}`;
                    } else if (action.switch_by === 'specific_units') {
                        details += `<strong>Units:</strong> ${parseFloat(action.switch_units).toLocaleString()}`;
                    }
                    break;
                    
                case 'stp':
                    details = `<strong>From:</strong> ${action.source_scheme}<br>`;
                    details += `<strong>To:</strong> ${action.target_scheme}<br>`;
                    details += `<strong>Amount:</strong> ₹${parseFloat(action.stp_amount).toLocaleString()} ${action.stp_frequency}`;
                    break;
                    
                case 'sip':
                    details = `<strong>Scheme:</strong> ${action.target_scheme}<br>`;
                    details += `<strong>Amount:</strong> ₹${parseFloat(action.sip_amount).toLocaleString()} ${action.sip_frequency}<br>`;
                    details += `<strong>Date:</strong> ${action.sip_date}`;
                    break;
                    
                case 'swp':
                    details = `<strong>From:</strong> ${action.source_scheme}<br>`;
                    details += `<strong>Amount:</strong> ₹${parseFloat(action.swp_amount).toLocaleString()} ${action.swp_frequency}<br>`;
                    details += `<strong>Date:</strong> ${action.swp_date}`;
                    break;
            }
            
            return details;
        }

        function editAction(index) {
            const action = plannedActions[index];
            
            // Populate form with action data
            populateActionForm(action);
            
            // Remove action from list (will be re-added when form is submitted)
            plannedActions.splice(index, 1);
            displayPlannedActions();
            updateActionsSummary();
            
            // Show modal
            $('#actionModal').modal('show');
        }

        function populateActionForm(action) {
            // Reset form first
            resetActionForm();
            
            // Set action type
            selectActionType(action.action_type);
            
            // Set common fields
            $('#source-scheme').val(action.source_scheme);
            $('#target-scheme').val(action.target_scheme);
            $('#action-notes').val(action.notes);
            
            // Set type-specific fields
            switch(action.action_type) {
                case 'redeem':
                    $('#redeem-by').val(action.redeem_by);
                    $('#redeem-amount').val(action.redeem_amount);
                    $('#redeem-units').val(action.redeem_units);
                    toggleAmountField('redeem');
                    break;
                case 'switch':
                    $('#switch-by').val(action.switch_by);
                    $('#switch-amount').val(action.switch_amount);
                    $('#switch-units').val(action.switch_units);
                    toggleAmountField('switch');
                    break;
                case 'stp':
                    $('#stp-amount').val(action.stp_amount);
                    $('#stp-frequency').val(action.stp_frequency);
                    break;
                case 'sip':
                    $('#sip-amount').val(action.sip_amount);
                    $('#sip-frequency').val(action.sip_frequency);
                    $('#sip-date').val(action.sip_date);
                    break;
                case 'swp':
                    $('#swp-amount').val(action.swp_amount);
                    $('#swp-frequency').val(action.swp_frequency);
                    $('#swp-date').val(action.swp_date);
                    break;
            }
        }

        function removeAction(index) {
            if (confirm('Are you sure you want to remove this action?')) {
                plannedActions.splice(index, 1);
                displayPlannedActions();
                updateActionsSummary();
            }
        }

        function updateActionsSummary() {
            let totalInvestment = 0;
            let totalRedemption = 0;
            let sipCount = 0;
            let redeemCount = 0;
            let switchCount = 0;
            let systematicCount = 0;
            
            plannedActions.forEach(function(action) {
                switch(action.action_type) {
                    case 'sip':
                        if (action.sip_amount) {
                            totalInvestment += parseFloat(action.sip_amount);
                            sipCount++;
                        }
                        break;
                    case 'redeem':
                        if (action.redeem_amount) {
                            totalRedemption += parseFloat(action.redeem_amount);
                        }
                        redeemCount++;
                        break;
                    case 'switch':
                        switchCount++;
                        break;
                    case 'stp':
                    case 'swp':
                        systematicCount++;
                        break;
                }
            });
            
            const netInvestment = totalInvestment - totalRedemption;
            
            // Update summary display
            $('#total-investment').text(`₹${totalInvestment.toLocaleString()}`);
            $('#total-redemption').text(`₹${totalRedemption.toLocaleString()}`);
            $('#net-investment').text(`₹${netInvestment.toLocaleString()}`);
            $('#action-count').text(`${plannedActions.length} Actions`);
            
            // Update action type counts
            $('#sip-count').text(sipCount);
            $('#redeem-count').text(redeemCount);
            $('#switch-count').text(switchCount);
            $('#systematic-count').text(systematicCount);
            
            // Enable/disable save buttons
            const hasActions = plannedActions.length > 0;
            $('#save-plan-btn, #submit-plan-btn').prop('disabled', !hasActions);
        }

        // Plan Saving Functions
        function savePlan(submitForApproval = false) {
            if (plannedActions.length === 0) {
                alert('Please add at least one action before saving the plan.');
                return;
            }
            
            // Show plan name modal
            $('#planNameModal').modal('show');
            
            // Store submit flag for later use
            window.submitForApproval = submitForApproval;
        }

        function submitPlan(submitForApproval) {
            const planName = $('#plan-name').val().trim();
            
            if (!planName) {
                alert('Plan name is required.');
                return;
            }
            
            const planData = {
                client_id: {{ client.id }},
                plan_name: planName,
                description: $('#plan-description').val(),
                actions: plannedActions,
                submit_for_approval: submitForApproval
            };
            
            // Show loading state
            const saveBtn = submitForApproval ? $('#submit-approval-btn') : $('#save-draft-btn');
            const originalText = saveBtn.html();
            saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            
            // Submit to server
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
                    }
                }
            });
            
            $.ajax({
                url: '{% url "save_execution_plan" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(planData),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        // Redirect to plan detail page
                        window.location.href = response.plan_url;
                    } else {
                        alert('Error: ' + response.error);
                        saveBtn.prop('disabled', false).html(originalText);
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'An error occurred while saving the plan.';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.error || errorMessage;
                    } catch(e) {}
                    
                    alert(errorMessage);
                    saveBtn.prop('disabled', false).html(originalText);
                }
            });
        }

        // Template Functions
        function loadTemplate() {
            // Placeholder for template loading functionality
            alert('Template functionality will be implemented in the next phase.');
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function truncateText(text, maxLength = 50) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }

        // Add CSRF token to all AJAX requests
        $(document).ready(function() {
            // Get CSRF token from cookie or meta tag
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken');
            
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
        });

        // Keyboard shortcuts
        $(document).on('keydown', function(e) {
            // Ctrl+S to save as draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (plannedActions.length > 0) {
                    savePlan(false);
                }
            }
            
            // Ctrl+Shift+S to save and submit
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                if (plannedActions.length > 0) {
                    savePlan(true);
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                $('.modal').modal('hide');
            }
        });

        // Auto-save functionality (optional)
        let autoSaveTimer;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(function() {
                if (plannedActions.length > 0) {
                    // Auto-save to localStorage
                    localStorage.setItem('executionPlanDraft', JSON.stringify({
                        client_id: {{ client.id }},
                        actions: plannedActions,
                        timestamp: new Date().toISOString()
                    }));
                }
            }, 30000); // Auto-save every 30 seconds
        }

        // Load draft from localStorage on page load
        $(document).ready(function() {
            const draft = localStorage.getItem('executionPlanDraft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    if (data.client_id === {{ client.id }} && data.actions && data.actions.length > 0) {
                        if (confirm('A draft plan was found for this client. Would you like to restore it?')) {
                            plannedActions = data.actions;
                            displayPlannedActions();
                            updateActionsSummary();
                        }
                    }
                } catch(e) {
                    console.error('Error loading draft:', e);
                }
            }
        });

        // Clear draft when plan is successfully saved
        function clearDraft() {
            localStorage.removeItem('executionPlanDraft');
        }

        // Schedule auto-save whenever actions are modified
        function onActionsModified() {
            updateActionsSummary();
            scheduleAutoSave();
        }

        // Warning before leaving page with unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (plannedActions.length > 0) {
                e.preventDefault();
                e.returnValue = '';
                return 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
    </script>

    <!-- Add CSRF token for AJAX requests -->
    {% csrf_token %}
    <script>
        // Make CSRF token available to JavaScript
        window.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <!-- Additional CSS for responsiveness -->
    <style>
        @media (max-width: 768px) {
            .action-controls {
                margin-top: 10px;
            }
            
            .action-card .card-body {
                padding: 0.75rem;
            }
            
            .btn-group .btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            
            .client-summary .row > div {
                margin-bottom: 1rem;
            }
            
            .asset-allocation-bar {
                height: 15px;
            }
        }
        
        @media (max-width: 576px) {
            .action-type-btn {
                margin-bottom: 0.5rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .modal-lg {
                max-width: 90%;
            }
        }
        
        /* Print styles */
        @media print {
            .btn, .modal, .action-controls {
                display: none !important;
            }
            
            .action-card {
                border: 1px solid #000 !important;
                page-break-inside: avoid;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .scheme-search-result:hover {
                background-color: #2d3748;
            }
            
            .action-card:hover {
                border-color: #4299e1;
                box-shadow: 0 2px 8px rgba(66,153,225,0.15);
            }
        }
    </style>
</body>
</html>